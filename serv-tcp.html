<html>
	<head>
		<link rel="stylesheet" href="style.css" media="screen" />
		<title>Cozis - Scriviamo server TCP</title>
	</head>
	<body>
		<a href="intro.html">Indice</a>

		<h1>Scriviamo un server TCP in C!</h1>
		<p>In questa guida intendo mostrare come si può creare un server TCP in C su Linux. Questa guida spallidisce al confronto con altre che sono reperibili su internet, ma per completezza, relativamente ad altre guide di questo blog (come quelle sui web server), ho deciso di scriverla comunque. Anche perchè, nonostante la quantità di contenuti reperibili sia infinita, sono per lo più in inglese.</p>

		<h2>1. Teoria!</h2>

		<h3>1.1 Cos'è un server? Cos'è TCP? Cos'è un server TCP?!</h3>

		<p>I computer possono comunicare fra loro inviandosi arbitrarie sequenze di byte. Su due piedi uno penserebbe che questi canali di comunicazione possono avvenire quando i due computer contemporaneamente scelgono di interagire. Pensandoci attentamente però, la comunicazione può avvenire solo quando uno dei due nodi sceglie di cominciare la comunicazione con l'altro, unidirezionalmente. Quindi uno dei due deve essere sempre in attesa di connessioni. Del resto è così anche con i telefoni cellulare. Ciascuno di noi è perennemente in attesa di chiamate (o almeno quando il telefono è acceso) in modo tale che nell'esatto momento in cui qualcuno vuole chiamarci, anche noi siamo pronti per la comunicazione. Se noi avessimo il cellulare spento accetto quando vogliamo ricevere una chiamata, e gli altri ci provassero a chiamare quando vogliono interagire, probabilmente non riusciremmo mai a parlare! Per questo motivo uno dei computer deve essere sempre in ascolto per connessioni mentre è l'altro che decide quando cominciare la comunicazione. In questo contesto, il computer che è sempre pronto ad interagire è chiamato <b>server</b>, mentre l'altro è chiamato <b>client</b>. Un esempio di questa architettura sono il browser e le macchine che mantengono i siti web. Il browser sono i client e le macchine che mantengono i siti sono i server. Questi server mantengono i siti e lo mandano ad ogni client che lo chiede.</p>

		<p>Per far avvenire questa comunicazione, i computer devono essere collegati fisicamente con dei cavi. Una volta collegati, a ciascun computer è associato un identificativo univoco (noto come indirizzo IP) che può essere usato per contattarlo. A questo punto è necessario fare un'ulteriore considerazione. In effetti, quando diciamo che due computer stanno comunicando, in realtà sono due programmi su questi computer che stanno comunicando. Ma su un computer possono girare più di un programma, quindi un identificativo all'intero computer non basta. È necessario introdurre un identificativo aggiuntivo per i vari programmi all'interno di ciascun computer che ha a sua volta un identificativo. L'identificativo del programma è detto porta, mentre quello del computer è detto indirizzo. Un programma, per avviare la comunicazione con un programma remoto, deve conoscere la coppia (indirizzo, porta) di quest'ultimo. Usualmente per spiegare quest'idea si usa la metafora secondo la quale la rete internet è una città, dove ciascun palazzo è un computer ed ogni camera del palazzo è un programma. Per andare da casa nostra a quella di un nostro amico, abbiamo bisogno di indirizzo e numero di porta.</p>

		<font color="red">Come è fatto un indirizzo? Ed una porta? E cosa sono le "reti" in generale?</font>

		<p>Il TCP è uno dei protocolli che permette la comunicazione di questi byte. Questa è una descrizione molto astratta, ma per fortuna ci basta sapere questo dato che il sistema operativo si occupa dei dettagli per noi. Esistono altri protocolli, come ad esempio l'UDP, ma al momento non ci interessano.</p>

		<p>Quindi, finalmente, <b>un server TCP è un programma che ascolta su una determinata porta per connessioni TCP</b> di altri computer.</p>

		<h2>2. Programmiamoo</h2>
		
		<p>
			Un programma che implementa un server TCP deve fare le seguenti cose:
		</p>

			<ol>
				<li>Creare un socket</li>
				<li>Associare il socket ad un indirizzo ed una porta</li>
				<li>Cominciare ad ascoltare per richieste</li>
				<li>Leggere le richieste</li>
				<li>Inviare risposte</li>
			</ol>

		<p>
			Quindi, in prima approssimazione, avremo una cosa del genere (in pseudo-codice):
		</p>

		<textarea disabled>
socket = create_TCP_socket()

set_address_and_port(socket, address, port)
		
listen(socket)
		
while true
	{
		connection = accept(socket)

		request = read(connection)

		response = build_response(request)

		send(connection, response)
	}</textarea>

		<h3>2.1 I socket</h3>
		<p>
			Hei hei hei! Aspetta un attimo!! Ed ora cos'è 'sto socket?! Vi starete chiedendo..
		</p>
		<p>
			I socket sono un'astrazione del sistema operativo che permette ai programmatori di non dover pensare ai dettagli implementativi dei meccanismi che permettono la comunicazione fra computer. Invece di pensare a driver della scheda di rete, buffer di input e buffer di output, ci basta pensare "ok, ora apriamo un socket!".
		</p>
		<p>Su Linux, un socket si crea usando la funzione <code>socket</code> definita in <code>sys/socket.h</code></p>

		<textarea disabled>
#include <sys/socket.h>

int socket(int domain, int type, int protocol);</textarea>

		<p>
			L'argomento <code>domain</code> fa riferimento al dominio del socket. Questo può essere <code>AF_INET</code> per la comunicazione fra due computer diversi, oppure <code>AF_UNIX</code> per la comunicazione fra due processi di uno stesso computer. L'argomento <code>type</code> fa riferimento al tipo del socket. Qui è dove specifichiamo di volere un socket TCP fornendo il valore <code>SOCK_STREAM</code>. Infine, l'argomento <code>protocol</code> onestamente non ci interessa. Possiamo fornire un bel 0. Questa funzione ritorna l'identificativo del nostro socket. Se invece la funzione per qualche motivo fallisce, un valore negativo è ritornato. Questo identificativo ci servirà per affettuare operazioni sul socket come leggere e scrivere byte dalla connessione. Quando il socket non ci serve più, possiamo chiuderlo chiamando la funzione <code>close</code>
		</p>

		<p>La prima parte del nostro server TCP quindi diventa:</p>

		<textarea disabled>
#include <sys/socket.h>

int main()
{
	int fd = socket(AF_INET, SOCK_STREAM, 0);

	if(fd < 0)
		{
			fprintf(stderr, "La creazione del socket è fallita!\n");
			return -1;
		}

	// ..facciamo cose col socket..

	close(fd);
	return 0;
}</textarea>

	<p>NOTA: Spesso si usa <code>fd</code> come nome della variabile del socket (in generale degli identificativi relativi a strutture dati interne al kernel di Linux) perchè sta per <i>File Descriptor</i>. In Linux, ogni cosa è vista come un file dal quale si può leggere e scrivere, anche i socket.</p>

		---------------------
		Potrebbero anche interessarti:
		...
		...

		<script src="scripts.js"></script>
	</body>
</html>